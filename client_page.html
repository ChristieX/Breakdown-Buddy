<!DOCTYPE html>
<html lang="en">
<head>
  <title>Client Page</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Gasoek+One&family=Slackside+One&display=swap" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&display=swap" rel="stylesheet" />
  <!-- Add Leaflet CSS -->
  <!-- Latest Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

  <!-- Latest Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<style>
  * {
    margin: 0;
    padding: 0;
  }
  header {
    background-color: #780000;
    color: #fff;
    padding: 20px;
    text-align: center;
    width: 100vw;
  }

  h1 {
    margin: 0;
  }
  header h1 {
    font-family: "Cherry Bomb One", cursive;
  }
  nav {
    background-color: #c1121f;
    padding: 10px;
    position: sticky;
    width: 100vw;
  }
  ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  li {
    display: inline;
    margin-right: 10px;
  }

  li a {
    color: #fff;
    text-decoration: none;
    padding: 5px 10px;
  }

  li a:hover {
    background-color: #730b12;
  }
  marquee {
    font-family: "Slackside One", cursive;
    font-size: 50px;
    padding: 0;
  }
  body {
    margin: 0;
    padding: 0;
  }
  #locationbtn {
    background-color: #6e0b07;
    color: rgb(248, 241, 241);
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
  }
  .button {
    top: 2%;
    right: 1%;
    position: absolute;
    background: linear-gradient(to right, #ae474d, #780000);
    color: #fff;
    border-radius: 30px;
    padding: 10px 30px;
    cursor: pointer;
    display: block;
    transition-duration: 0.5s;
    border: 0;
    outline: none;
  }
  #mapContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #map {
    height: 400px;
    width: 100%;
  }

  #mechanicsListContainer {
    margin-top: 20px;
  }
</style>
<body>
  <header>
    <button class="button" onclick="window.location.href = 'login.html';">Logout</button>
    <h1>BREAKDOWN BUDDY</h1>
  </header>
  <nav>
    <ul>
      <li><a href="homepage.html">Home</a></li>
      <li><a href="request_assistance.html">Request Assistance</a></li>
      <li><a href="assistance_guides1.html">Assistant Guides</a></li>
      <li><a href="contacts.html">Emergency Contacts</a></li>
      <li><a href="about_us.html">About Us</a></li>
      <li><a href="client_dashboard.php">Dashboard</a></li>
    </ul>
  </nav>
  <marquee>~RELIABLE HELP FOR UNRELIABLE BREAKDOWNS~</marquee>
  <main>
    <h2>Client Geolocation</h2>
    <p>Click the button below to use your geolocation:</p>
    <button onclick="getClientLocation()" id="locationbtn">Use My Location</button>

    <!-- Map and Mechanics Container -->
    <div id="mapContainer">
      <!-- Leaflet map container -->
      <div id="map"></div>
    </div>
    <!-- Mechanics Table Container -->
    <div id="mechanicsListContainer">
      <!-- Mechanics Table -->
      <div id="mechanicsList"></div>
    </div>
    <!-- Additional Result Div for Closest Mechanics -->
    <div id="result"></div>
  </main>

  <script>
     let map;
  let clientLatitude; // Client's latitude
  let clientLongitude; // Client's longitude
  let requestData; // Declare requestData globally
  let locationBtn; // Declare locationBtn globally

// ... (your existing code)

// Function to initialize the Leaflet map with the client's location
function initializeMap() {
  map = L.map('map').setView([clientLatitude, clientLongitude], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Place a marker on the map for the client's location
  L.marker([clientLatitude, clientLongitude]).addTo(map)
    .bindPopup("Your Location")
    .openPopup();

  // Send the latitude and longitude data to the server to store it in the database
  requestData = {
    latitude: clientLatitude,
    longitude: clientLongitude
  };

  fetch('save_location.php', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestData)
  })
    .then(response => response.text())  // Change this line to response.text()
    .then(data => {
      console.log(data);  // Log the response

      // Check if the response contains an error
      if (data.includes('error')) {
        throw new Error(data);  // Throw an error to trigger the catch block
      }

      locationBtn.innerHTML = 'Location Saved';

      // Update requestData and fetch closest mechanics
      requestData = {
        latitude: clientLatitude,
        longitude: clientLongitude
      };
      fetchClosestMechanics();
    })
    .catch(error => {
      console.error('Error saving location:', error);
      locationBtn.innerHTML = 'Error Locating';
    });
}

// ... (your existing code)


  // Function to get client's geolocation and display on a Leaflet map
  function getClientLocation() {
    locationBtn = document.getElementById('locationbtn'); // Move this line inside the function
    locationBtn.innerHTML = 'Locating...';

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          clientLatitude = position.coords.latitude;
          clientLongitude = position.coords.longitude;

          console.log('Client Latitude:', clientLatitude);
          console.log('Client Longitude:', clientLongitude);

          // Check if the client's location is available
          if (clientLatitude && clientLongitude) {
            // After getting the location, initialize the map
            initializeMap();
          } else {
            console.error("Client's geolocation is not available.");
            locationBtn.innerHTML = 'Error Locating';
          }
        },
        (error) => {
          console.error("Error getting geolocation:", error.message);
          locationBtn.innerHTML = 'Error Locating';
        }
      );
    } else {
      console.error("Geolocation is not supported by this browser.");
      locationBtn.innerHTML = 'Geolocation Not Supported';
    }
  }

    // Function to fetch and display the closest mechanics
    // Function to fetch and display the closest mechanics
// Function to fetch and display the closest mechanics
function fetchClosestMechanics() {
  if (requestData) {
    fetch('test_get_closest_mechanic.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestData)
    })
      .then(response => response.text()) // Change this line to response.text()
      .then(data => {
        console.log('Response from server:', data); // Log the response

        try {
          // Try to parse the JSON data
          const jsonData = JSON.parse(data);
          displayMechanics(jsonData);
        } catch (error) {
          console.error('Error parsing JSON:', error);
        }
      })
      .catch(error => {
        console.error('Error fetching mechanics:', error);
      });
  } else {
    console.error('requestData is not defined.');
  }
}


// Function to display the list of mechanics
function displayMechanics(mechanics) {
  const mechanicsList = document.getElementById('mechanicsList');
  const resultDiv = document.getElementById('result');
  mechanicsList.innerHTML = ''; // Clear existing content
  resultDiv.innerHTML = '<h2>Closest Mechanics:</h2>'; // Clear existing content

  if (mechanics.length > 0) {
    let tableContent = '<table border="1"><tr><th>Company Name</th><th>Shop Name</th><th>City</th><th>Distance</th><th>Action</th></tr>';

    mechanics.forEach(mechanic => {
      const distance = parseFloat(mechanic.distance);
      const formattedDistance = !isNaN(distance) ? distance.toFixed(2) + ' km' : 'N/A';

      tableContent += `
        <tr>
          <td>${mechanic.companyName}</td>
          <td>${mechanic.shopName}</td>
          <td>${mechanic.city}</td>
          <td>${formattedDistance}</td>
          <td><button onclick="requestAssistance(${mechanic.mechanic_id}, ${mechanic.latitude}, ${mechanic.longitude})">Request Assistance</button></td>
        </tr>
      `;

      resultDiv.innerHTML += `<p>Latitude: ${mechanic.latitude}, Longitude: ${mechanic.longitude}, Distance: ${formattedDistance}</p>`;
    });

    tableContent += '</table>';
    mechanicsList.innerHTML = tableContent;
  } else {
    mechanicsList.innerHTML = '<p>No mechanics found nearby.</p>';
    resultDiv.innerHTML = ''; // Clear result div if no mechanics found
  }
}


  function requestAssistance(mechanicId, latitude, longitude) {
  // Implement your logic to handle the request assistance action
  console.log(`Request assistance for Mechanic ID: ${mechanicId}, Latitude: ${latitude}, Longitude: ${longitude}`);


  // Prepare data for the POST request
  // Prepare data for the POST request
const requestData = {
  mechanic_id: mechanicId,
};

// Send a POST request to save_incident.php
fetch('save_incident.php', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(requestData)
})
.then(response => {
  if (!response.ok) {
    throw new Error('Network response was not ok');
  }
  return response.json();
})
.then(data => {
  // Handle the JSON response
})
.catch(error => {
  console.error('Error in the request to save_incident.php:', error);
  // Handle the error, show a message, or perform other actions
});



}

    // Trigger the client location retrieval when the page loads
    getClientLocation();

  </script>

</body>
</html>